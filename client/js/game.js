function Game(){}function initBoard(e,r){board.W=r,board.H=e,board.isBloc=new Array(r),board.isXp=new Array(r);for(var a=0;r>a;a++){board.isBloc[a]=new Array(e),board.isXp[a]=new Array(e);for(var o=0;e>o;o++)board.isBloc[a][o]=EMPTY_BLOC,board.isXp[a][o]=!1}}function tick(){var e=Date.now(),r=e-lastUpdate;return lastUpdate=e,r/1e3}function updatePlayerDirection(){lastDirectionPressed!=NO_KEY&&(delta=(player.x-turnPosition[0])*player.dx+(player.y-turnPosition[1])*player.dy,delta<0||(player.x=Math.round(player.x),player.y=Math.round(player.y),lastDirectionPressed==KEY_LEFT&&0==player.dx?changePlayerDirection(-1,0):lastDirectionPressed==KEY_RIGHT&&0==player.dx?changePlayerDirection(1,0):lastDirectionPressed==KEY_DOWN&&0==player.dy?changePlayerDirection(0,1):lastDirectionPressed==KEY_UP&&0==player.dy&&changePlayerDirection(0,-1),player.x+=player.dx*delta,player.y+=player.dy*delta,lastDirectionPressed=comboDirectionPressed,comboDirectionPressed=NO_KEY,updateTurnTargetPosition()))}function changePlayerDirection(e,r){player.dx=e,player.dy=r,socket.emit("directionChange",{dx:player.dx,dy:player.dy})}function movePlayer(e,r){e.x+=e.dx*e.velocity*r,e.y+=e.dy*e.velocity*r;var a=Math.round(e.x-.5*e.dx),o=Math.round(e.y-.5*e.dy);a=Math.min(Math.max(a,0),board.W-1),o=Math.min(Math.max(o,0),board.H-1),board.isBloc[a][o]=e.hue;var t=!1;return!e.lastPos||e.lastPos[0]==a&&e.lastPos[1]==o||(t=!0),e.lastPos=[a,o],t}function drawPlayer(e,r){e.fillStyle="hsl("+r.hue+", 100%, 50%)",e.strokeStyle="hsl("+r.hue+", 90%, 40%)",e.lineWidth=5,e.lineJoin="round",e.lineCap="round";var a=getBlocDrawCoordinates(r.x,r.y,HALF_BLOC_SIZE_DISPLAY);e.fillRect(a[0],a[1],a[2],a[3]),e.strokeRect(a[0],a[1],a[2],a[3]),e.fillStyle="hsl("+r.hue+", 100%, 90%)",e.strokeStyle="hsl("+r.hue+", 90%, 40%)",e.font="bold 50px Verdana",e.textAlign="center",e.lineWidth=2,a=boardToScreen(r.x,r.y-1),e.fillText(r.name,a[0],a[1]),e.strokeText(r.name,a[0],a[1])}function drawBoard(e){LosW=screenWidth/2/BLOC_TO_PIXELS,LosH=screenHeight/2/BLOC_TO_PIXELS,LosX0=Math.round(Math.max(player.x-LosW,0)),LosX1=Math.round(Math.min(player.x+LosW,board.W-1)),LosY0=Math.round(Math.max(player.y-LosH,0)),LosY1=Math.round(Math.min(player.y+LosH,board.H-1));for(var r=-1;r<colors.length;r++){var a;-1==r?(a=SIDE_WALL,e.fillStyle=BLOC_COLOR):(a=colors[r],e.fillStyle="hsl("+a+", 50%, 80%)");for(var o=2*HALF_BLOC_SIZE_DISPLAY,t=0,n=Math.round(BLOC_TO_PIXELS*(LosX0-player.x)+screenWidth/2)-HALF_BLOC_SIZE_DISPLAY,l=LosX0;l<=LosX1;l++){t=Math.round(BLOC_TO_PIXELS*(LosY0-player.y)+screenHeight/2)-HALF_BLOC_SIZE_DISPLAY;for(var i=LosY0;i<=LosY1;i++)board.isBloc[l][i]==a&&e.fillRect(n,t,o,o),t+=BLOC_TO_PIXELS;n+=BLOC_TO_PIXELS}}e.fillStyle=XP_COLOR,e.strokeStyle=XP_SCOLOR,e.lineWidth=XP_STROKE;for(var s=2*Math.PI,t=0,n=Math.round(BLOC_TO_PIXELS*(LosX0-player.x)+screenWidth/2),l=LosX0;l<=LosX1;l++){t=Math.round(BLOC_TO_PIXELS*(LosY0-player.y)+screenHeight/2);for(var i=LosY0;i<=LosY1;i++)board.isXp[l][i]&&(e.beginPath(),e.arc(n,t,XP_RADIUS,0,s),e.fill(),e.stroke()),t+=BLOC_TO_PIXELS;n+=BLOC_TO_PIXELS}}function drawLinks(e){links&&links.forEach(function(r){for(var a=boardToScreen(r.x0,r.y0,!0),o=r.x0+(r.x1-r.x0)*(1.6*r.progress),t=r.y0+(r.y1-r.y0)*(1.6*r.progress),n=boardToScreen(o,t,!0),l=new Array(22),i=0,s=0;20>=s;s+=2)l[s]=a[0]+(n[0]-a[0])*i+getRandomInt(-1*LINK_JITTER,LINK_JITTER),l[s+1]=a[1]+(n[1]-a[1])*i+getRandomInt(-1*LINK_JITTER,LINK_JITTER),i+=.05;e.strokeStyle=LINK_SCOLOR,e.lineWidth=LINK_OUTER,e.beginPath(),e.moveTo(l[0],l[1]);for(var s=2;s<l.length;s+=2)e.lineTo(l[s],l[s+1]);e.stroke(),e.strokeStyle=LINK_COLOR,e.lineWidth=LINK_INNER,e.beginPath(),e.moveTo(l[0],l[1]);for(var s=2;s<l.length;s+=2)e.lineTo(l[s],l[s+1]);e.stroke()})}function usePowerup(){if(player&&0==player.cooldown){var e=Math.round(player.x+player.dx*player.teleportDist),r=Math.round(player.y+player.dy*player.teleportDist);e>1&&r>1&&e<board.W-2&&r<board.H-2&&(player.x=e,player.y=r,socket.emit("powerupUsed",e,r),player.cooldown=player.maxCooldown,clearFutureTurns())}}function displayLeaderBoard(e){var r="<h1>Leaderboard</h1>";i=1,e&&e.forEach(function(e){r+="<br />",r+='<span style="float:left">'+i++ +". "+e.name+'</span>&nbsp;&nbsp;&nbsp;<span style="float:right">'+e.score+"</span>"}),document.getElementById("status").innerHTML=r}function boardToScreen(e,r,a){return a?[BLOC_TO_PIXELS*(e-player.x)+screenWidth/2,BLOC_TO_PIXELS*(r-player.y)+screenHeight/2]:[Math.round(BLOC_TO_PIXELS*(e-player.x)+screenWidth/2),Math.round(BLOC_TO_PIXELS*(r-player.y)+screenHeight/2)]}function getBlocDrawCoordinates(e,r,a){var o=boardToScreen(e,r);return[o[0]-a,o[1]-a,2*a,2*a]}function bindClickTap(e){e.addEventListener("click",function(e){var r=screenWidth/2,a=screenHeight/2,o=e.x-r,t=a-e.y;if(Math.sqrt(o*o+t*t)<=screenWidth*TAP_CENTER_REL_DIST)return void(gameOver?socket.emit("respawnRequest",playerName):gameOver||usePowerup());var n=null,l=180*Math.atan2(o,t)/Math.PI;n=-135>l||l>135?KEY_DOWN:-45>l?KEY_LEFT:l>45?KEY_RIGHT:KEY_UP,applyKeyboardDirectionLogic(n)},!1)}function bindKeyboard(e){e.addEventListener("keydown",directionDown,!1)}function directionDown(e){var r=e.which||e.keyCode;r==KEY_LEFT||r==KEY_RIGHT||r==KEY_DOWN||r==KEY_UP?applyKeyboardDirectionLogic(r):r==KEY_SPACE&&(gameOver?socket.emit("respawnRequest",playerName):gameOver||usePowerup())}function applyKeyboardDirectionLogic(e){gameOver||(lastDirectionPressed==NO_KEY?(lastDirectionPressed=e,updateTurnTargetPosition()):comboDirectionPressed=e)}function clearFutureTurns(){turnPosition=[0,0],lastDirectionPressed=NO_KEY,comboDirectionPressed=NO_KEY}function updateTurnTargetPosition(){turnPosition[0]=Math.round(player.x+player.dx/2),turnPosition[1]=Math.round(player.y+player.dy/2)}function getRandomInt(e,r){return Math.floor(Math.random()*(r-e+1))+e}Game.prototype.handleNetwork=function(e){e.emit("myNameIs",playerName);var r=document.getElementById("cvs");r.width=screenWidth,r.height=screenHeight,bindKeyboard(r),bindClickTap(r),e.on("playerSpawn",function(e,r){initBoard(r.boardW,r.boardH),player=e,player.name=playerName,gameOver=!1,tick()}),e.on("updateBoard",function(e){for(var r=e.x0;r<e.x1;r++)for(var a=e.y0;a<e.y1;a++)board.isXp[r][a]=e.isXp[r-e.x0][a-e.y0],board.isBloc[r][a]=e.isBloc[r-e.x0][a-e.y0];lastFewBlocs.forEach(function(e){board.isBloc[e[0]][e[1]]=player.hue}),colors=e.colors}),e.on("updatePlayers",function(e,r){e.forEach(function(e){if(otherPlayers)for(var r=0;r<otherPlayers.length;r++){var a=otherPlayers[r];if(a.name===e.name&&a.hue===e.hue){a.dx==e.dx&&a.dy==e.dy&&Math.abs(a.x-e.x)+Math.abs(a.y-e.y)<(Math.abs(a.dx)+Math.abs(a.dy))*a.velocity*.1&&(e.x=otherPlayers[r].x,e.y=otherPlayers[r].y);break}}}),otherPlayers=e,links=r}),e.on("playerDied",function(){gameOver=!0}),e.on("newSpeed",function(e){player.velocity=e}),e.on("newHue",function(e){player.hue=e}),e.on("updateLeaderBoard",function(e){displayLeaderBoard(e)})},Game.prototype.handleLogic=function(){if(player&&!gameOver){var e=tick(),r=movePlayer(player,e);r&&(socket.emit("playerMove",{x:player.x,y:player.y}),player.lastPos&&(lastFewBlocs[lastFewBlocsId]=player.lastPos,lastFewBlocsId=(lastFewBlocsId+1)%FEW_BLOCS_SIZE)),updatePlayerDirection(),otherPlayers&&otherPlayers.forEach(function(r){movePlayer(r,e)}),player.cooldown=Math.max(0,player.cooldown-e)}},Game.prototype.handleGraphics=function(e){if(player){if(e.fillStyle="#fbfcfc",e.fillRect(0,0,screenWidth,screenHeight),gameOver)return e.fillStyle="#2ecc71",e.strokeStyle="#27ae60",e.font="bold 50px Verdana",e.textAlign="center",e.lineWidth=2,e.fillText("G A M E  O V E R",.5*screenWidth,.4*screenHeight),e.strokeText("G A M E  O V E R",.5*screenWidth,.4*screenHeight),e.font="bold 25px Verdana",e.fillText("press space bar to respawn...",.5*screenWidth,.7*screenHeight),void e.strokeText("press space bar to respawn...",.5*screenWidth,.7*screenHeight);if(drawBoard(e),drawPlayer(e,player),otherPlayers&&otherPlayers.forEach(function(r){drawPlayer(e,r)}),drawLinks(e),player.cooldown>0){var r=.5*screenWidth-.8*HALF_BLOC_SIZE_DISPLAY,a=.5*screenHeight-1.5*HALF_BLOC_SIZE_DISPLAY,o=.5*screenWidth+.8*HALF_BLOC_SIZE_DISPLAY,t=a;e.strokeStyle="#000",e.lineWidth=10,e.beginPath(),e.moveTo(r,a),e.lineTo(o,t),e.stroke(),o=r+(o-r)*(1-player.cooldown/player.maxCooldown),e.strokeStyle="#fff",e.lineWidth=8,e.beginPath(),e.moveTo(r,a),e.lineTo(o,t),e.stroke()}}};var player=null,otherPlayers=null,board={H:0,W:0,isBloc:null,isXp:null},colors=[],links=[],lastFewBlocs=[],lastFewBlocsId=0,FEW_BLOCS_SIZE=5,lastUpdate=Date.now(),gameOver=!1,HALF_BLOC_SIZE_DISPLAY=18,BLOC_TO_PIXELS=36,BLOC_COLOR="#777",XP_RADIUS=10,XP_STROKE=3,XP_COLOR="#9900ff",XP_SCOLOR="#000066",LINK_COLOR="#99ccff",LINK_SCOLOR="#00264d",LINK_INNER=7,LINK_OUTER=15,LINK_JITTER=5,EMPTY_BLOC=-1,SIDE_WALL=-2,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,KEY_SPACE=32,NO_KEY=-1,TAP_CENTER_REL_DIST=.05,lastDirectionPressed=NO_KEY,comboDirectionPressed=NO_KEY,turnPosition=[0,0];